function getGmailData(a,b){chrome.identity.getAuthToken({interactive:!0},function(c){a||(a=25),getMailId(c,a,b)})}function getMailId(a,b,c){chrome.identity.getProfileUserInfo(function(d){email=encodeURIComponent(d.email);var e,f="&q="+encodeURIComponent("-in:chats -in:sent -in:notes"),g="https://www.googleapis.com/gmail/v1/users/"+email+"/messages?maxResults="+b+"&oauth_token="+a+f,h=[],i=[];$.ajax({url:g}).done(function(a){e=a,localStorage.setItem("Gmail_page",a.nextPageToken),localStorage.setItem("Gmail_error",!1),serviceData.GM.error=!1}).fail(function(a,b,d){console.log(a,b,d),localStorage.setItem("Gmail_error",!0),serviceData.GM.error=!0,c&&c()}).always(function(){$.each(e.messages,function(b,c){var d="https://www.googleapis.com/gmail/v1/users/"+email+"/messages/"+c.id+"?&oauth_token="+a;i.push($.ajax({url:d}).done(function(a){h.push(a),localStorage.setItem("Gmail_error",!1),serviceData.GM.error=!1}).fail(function(a,b,c){console.log(a,b,c),localStorage.setItem("Gmail_error",!0),serviceData.GM.error=!0}))}),$.when.apply($,i).done(function(){var a=rebuildGmailJson(h);localStorage.setItem("Gmail",JSON.stringify(a)),serviceData.GM.JSON=a,GmailHTML()}).always(function(){c&&c()})})})}function GmailHTML(){var a,b,c,d,e,f=serviceData.GM.JSON.sort(sortGmailResults),g="<h2>Unread</h2>",h="<h2>Read</h2>";$.each(f,function(f,i){a=i.labelIds.indexOf("DRAFT"),b=$("<div />").html(i.payload.headers.Subject).text()||"No subject",c=i.payload.headers.From.replace(/<(.|\n)*?>/,"")||"No sender",e=i.snippet||"No content",d=new Date(i.payload.headers.Date),d=moment(d).format(moment(d).isSame(moment(),"day")?"hh:mm A":"MMM D, hh:mm A");var j='<div class="gm-message core-item waves-effect"><a href="https://mail.google.com/mail/u/0/#inbox/'+i.id+'"><div class="gm-message-subject">'+b+'</div><div class="gm-message-date">'+d+'</div><div class="gm-message-from">'+c+"  -  "+e+"</div></a></div>";i.labelIds&&(-1!=i.labelIds.indexOf("UNREAD")?g+=j:h+=j)}),localStorage.setItem("GmailUnreadHTML",g),serviceData.GM.UnreadHTML=g,localStorage.setItem("GmailReadHTML",h),serviceData.GM.ReadHTML=h}function rebuildGmailJson(a){return $.each(a,function(a,b){$.each(b.payload.headers,function(a,c){b.payload.headers[c.name]=c.value})}),a}function sortGmailResults(a,b){return new Date(b.payload.headers.Date)-new Date(a.payload.headers.Date)}