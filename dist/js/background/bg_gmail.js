function getGmailData(a,b){chrome.identity.getAuthToken({interactive:!0},function(c){a||(a=25),getMailId(c,a,b)})}function getMailId(a,b,c){chrome.identity.getProfileUserInfo(function(d){email=encodeURIComponent(d.email);var e,f="&q="+encodeURIComponent("-in:chats -in:sent -in:notes"),g="https://www.googleapis.com/gmail/v1/users/"+email+"/messages?maxResults="+b+"&oauth_token="+a+f,h=[],i=[];$.ajax({url:g}).done(function(a){e=a,localStorage.setItem("Gmail_page",a.nextPageToken),localStorage.setItem("Gmail_error",!1),serviceData.GM.error=!1}).fail(function(a,b,d){console.log(a,b,d),localStorage.setItem("Gmail_error",!0),serviceData.GM.error=!0,c&&c()}).always(function(){$.each(e.messages,function(b,c){var d="https://www.googleapis.com/gmail/v1/users/"+email+"/messages/"+c.id+"?&oauth_token="+a;i.push($.ajax({url:d}).done(function(a){h.push(a),localStorage.setItem("Gmail_error",!1),serviceData.GM.error=!1}).fail(function(a,b,c){console.log(a,b,c),localStorage.setItem("Gmail_error",!0),serviceData.GM.error=!0}))}),$.when.apply($,i).done(function(){var a=rebuildGmailJson(h);localStorage.setItem("Gmail",JSON.stringify(a)),serviceData.GM.JSON=a,GmailHTML()}).always(function(){c&&c()})})})}function GmailHTML(){var a,b,c,d,e=serviceData.GM.JSON.sort(sortGmailResults),f="<h2>Unread</h2>",g="<h2>Read</h2>";$.each(e,function(e,h){a=$("<div />").html(h.payload.headers.Subject).text(),b=h.payload.headers.From.replace(/<(.|\n)*?>/,""),d=h.snippet,c=new Date(h.payload.headers.Date),c=moment(c).format(moment(c).isSame(moment(),"day")?"hh:mm A":"MMM D, hh:mm A");var i='<div class="gm-message core-item waves-effect"><a href="https://mail.google.com/mail/u/0/#inbox/'+h.id+'"><div class="gm-message-subject">'+a+'</div><div class="gm-message-date">'+c+'</div><div class="gm-message-from">'+b+"  -  "+d+"</div></a></div>";h.labelIds&&(-1!=h.labelIds.indexOf("UNREAD")?f+=i:g+=i)}),localStorage.setItem("GmailUnreadHTML",f),serviceData.GM.UnreadHTML=f,localStorage.setItem("GmailReadHTML",g),serviceData.GM.ReadHTML=g}function rebuildGmailJson(a){return $.each(a,function(a,b){$.each(b.payload.headers,function(a,c){b.payload.headers[c.name]=c.value})}),a}function sortGmailResults(a,b){return new Date(b.payload.headers.Date)-new Date(a.payload.headers.Date)}