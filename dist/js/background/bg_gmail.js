"use strict";function getGmailData(a,b){chrome.identity.getAuthToken({interactive:!0},function(c){a||(a=25),getMailId(c,a,b)})}function getMailId(a,b,c){chrome.identity.getProfileUserInfo(function(d){var e,f=encodeURIComponent(d.email),g="&q="+encodeURIComponent("-in:chats -in:sent -in:notes"),h="https://www.googleapis.com/gmail/v1/users/"+f+"/messages?maxResults="+b+"&oauth_token="+a+g,i=[],j=[];ajax("GET",h).then(function(b){e=b,localStorage.setItem("Gmail_page",b.nextPageToken),localStorage.setItem("Gmail_error",!1),serviceData.GM.error=!1,e.messages.forEach(function(b){var c="https://www.googleapis.com/gmail/v1/users/"+f+"/messages/"+b.id+"?&oauth_token="+a;j.push(ajax("GET",c).then(function(a){i.push(a),localStorage.setItem("Gmail_error",!1),serviceData.GM.error=!1},function(){localStorage.setItem("Gmail_error",!0),serviceData.GM.error=!0}))}),Promise.all(j).then(function(){var a=rebuildGmailJson(i);localStorage.setItem("Gmail",JSON.stringify(a)),serviceData.GM.JSON=a,GmailHTML(),c&&c()},function(){c&&c()})},function(){localStorage.setItem("Gmail_error",!0),serviceData.GM.error=!0,c&&c()})})}function GmailHTML(){var a,b,c,d,e,f=serviceData.GM.JSON.sort(sortGmailResults),g="<h2>Unread</h2>",h="<h2>Read</h2>";f.forEach(function(f){a=f.labelIds.indexOf("DRAFT"),b=f.payload.headers.Subject||"No subject",c=f.payload.headers.From.replace(/<(.|\n)*?>/,"")||"No sender",e=f.snippet||"No content",d=new Date(f.payload.headers.Date),d=moment(d).isSame(moment(),"day")?moment(d).format("hh:mm A"):moment(d).format("MMM D, hh:mm A");var i='<div class="gm-message core-item waves-effect"><a href="https://mail.google.com/mail/u/0/#inbox/'+f.id+'"><div class="gm-message-subject">'+htmlEncode(b)+'</div><div class="gm-message-date">'+htmlEncode(d)+'</div><div class="gm-message-from">'+htmlEncode(c)+"  -  "+htmlEncode(e)+"</div></a></div>";f.labelIds&&(f.labelIds.indexOf("UNREAD")!=-1?g+=i:h+=i)}),localStorage.setItem("GmailUnreadHTML",g),serviceData.GM.UnreadHTML=g,localStorage.setItem("GmailReadHTML",h),serviceData.GM.ReadHTML=h}function rebuildGmailJson(a){for(var b in a){var c=a[b];c.payload.headers.forEach(function(a){c.payload.headers[a.name]=a.value})}return a}function sortGmailResults(a,b){return new Date(b.payload.headers.Date)-new Date(a.payload.headers.Date)}